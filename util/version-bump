#!/usr/bin/env bash

set -euo pipefail

main() (
  root=$(cd $(dirname "${BASH_SOURCE[0]}")/.. && pwd -P)
  source "$root/.version.sh"

  version=$v_api
  for file in "${api_files[@]}"; do
    apply "$file" "$v_api"
  done

  version=$v_perl
  for file in "${perl_files[@]}"; do
    apply "$file" "$v_perl"
  done

  version=$v_python
  for file in "${python_files[@]}"; do
    apply "$file" "$v_python"
  done

  version=$v_raku
  for file in "${raku_files[@]}"; do
    apply "$file" "$v_raku"
  done

  version=$v_rust
  for file in "${rust_files[@]}"; do
    apply "$file" "$v_rust"
  done

  (
    set -x
    cd rust || exit
    cargo update
  )
)

apply() (
  [[ " ${yamlscript_files[*]} " == *" $file "* ]] &&
    bump 's{(yamlscript.*)\d+\.\d+\.\d+}{${1}'"$version"'}'
  [[ " ${YAMLSCRIPT_files[*]} " == *" $file "* ]] &&
    bump 's{(YAMLSCRIPT.*)\d+\.\d+\.\d+}{${1}'"$version"'}'
  [[ " ${yamlscript_core_files[*]} " == *" $file "* ]] &&
    bump 's{(yamlscript.*core.*)\d+\.\d+\.\d+}{${1}'"$version"'}'
  [[ " ${version_files[*]} " == *" $file "* ]] &&
    bump 's{(version.*)\d+\.\d+\.\d+}{${1}'"$version"'}'
  [[ " ${VERSION_files[*]} " == *" $file "* ]] &&
    bump 's{(VERSION.*)\d+\.\d+\.\d+}{${1}'"$version"'}'
  true
)

bump() (
  set -x
  perl -p0i -e "$1" "$file"
)

die() {
  echo "$*" >&2
  exit 1
}

[[ $0 != "${BASH_SOURCE[0]}" ]] || main "$@"
